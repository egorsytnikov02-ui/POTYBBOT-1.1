import asyncio
import logging
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import Message
from upstash_redis import Redis

# --- –ù–ê–°–¢–†–û–ô–ö–ò (–í—Å—Ç–∞–≤—å —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ) ---
TOKEN = "–¢–í–û–ô_–¢–û–ö–ï–ù_–¢–ï–õ–ï–ì–†–ê–ú"
UPSTASH_URL = "–¢–í–û–ô_UPSTASH_URL"
UPSTASH_TOKEN = "–¢–í–û–ô_UPSTASH_TOKEN"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –±–æ—Ç–∞
redis = Redis(url=UPSTASH_URL, token=UPSTASH_TOKEN)
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –†–ê–ù–ì–û–í ---
# –¢–µ–∫—Å—Ç—ã –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —É—Ä–æ–≤–Ω–µ–π
RANK_THRESHOLDS = {
    40: {
        "title": "–ü–û–¢–£–ñ–ù–Ü –ì–†–û–ú–ê–î–Ø–ù–ò üí™",
        "msg": (
            "–í—ñ–¥—á—É–≤–∞—î—Ç–µ —Ü–µ–π –ø—Ä–∏–ø–ª–∏–≤ —Å–∏–ª–∏? –ê—Ä–º—ñ—è, –ú–æ–≤–∞, –í—ñ—Ä–∞ —ñ –í–∞—à—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è! "
            "–í—ñ—Ç–∞—î–º–æ, —Ç–µ–ø–µ—Ä –í–∏ ‚Äî **–ü–û–¢–£–ñ–ù–Ü –ì–†–û–ú–ê–î–Ø–ù–ò** üí™. –¢—Ä–∏–º–∞–π—Ç–µ —Å—Ç—Ä—ñ–π, —Å–ø—ñ–ª—å–Ω–æ—Ç–∞!"
        )
    },
    80: {
        "title": "–°–•–Ü–î–ù–Ø–ö–ò üåÖ",
        "msg": (
            "–¶–µ–π —á–∞—Ç –ø—Ä–æ–π—à–æ–≤ –≥–æ—Ä–Ω–∏–ª–æ —ñ –≤–æ–≥–æ–Ω—å. –¢—É—Ç –±—ñ–ª—å—à–µ –Ω–µ–º–∞—î —Å–ª–∞–±–∫–∏—Ö —á–∏ –≤–∏–ø–∞–¥–∫–æ–≤–∏—Ö. "
            "–¢–µ–ø–µ—Ä –í–∏ ‚Äî **–°–•–Ü–î–ù–Ø–ö–ò** üåÖ. –°–æ–Ω—Ü–µ –≤—Å—Ç–∞—î —Ç–∞–º, –¥–µ –≤–∏—Ä—ñ—à–∏—Ç—å –≤–∞—à–∞ –±—ñ–ª—å—à—ñ—Å—Ç—å!"
        )
    },
    120: {
        "title": "–•–ê–†–ê–ö–¢–ï–†–ù–ò–ö–ò ‚öîÔ∏è",
        "msg": (
            "–í–∞—à—É —î–¥–Ω—ñ—Å—Ç—å –Ω–µ –±–µ—Ä—É—Ç—å –Ω—ñ –∫—É–ª—ñ, –Ω—ñ –±–∞–Ω–∏. –í–∏ —Ä–∞–∑–æ–º –≤–∏–π—à–ª–∏ –∑–∞ –º–µ–∂—ñ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—ñ "
            "—ñ –±–∞—á–∏—Ç–µ –º–∞–π–±—É—Ç–Ω—î. –¢–µ–ø–µ—Ä –í–∏ ‚Äî **–•–ê–†–ê–ö–¢–ï–†–ù–ò–ö–ò** ‚öîÔ∏è. –¶–µ–π —á–∞—Ç –æ—Ñ—ñ—Ü—ñ–π–Ω–æ –∑–∞—á–∞—Ä–æ–≤–∞–Ω–∏–π!"
        )
    },
    200: {
        "title": "–ó–ï–õ–ï–ë–û–ë–ò üü¢",
        "msg": (
            "–£–≤–∞–≥–∞! –¶–µ –∫—ñ–Ω–µ—Ü—å –µ–ø–æ—Ö–∏ –±—ñ–¥–Ω–æ—Å—Ç—ñ (–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å). –í–∏ –∑—Ä–æ–±–∏–ª–∏ —Ü–µ —Ä–∞–∑–æ–º! "
            "–í—Å—ñ –Ω–∞ —Å—Ç–∞–¥—ñ–æ–Ω! –í–∏ ‚Äî **–ó–ï–õ–ï–ë–û–ë–ò** üü¢. –í–∏ —Ç—É—Ç –≤–ª–∞–¥–∞, —ñ —Ü–µ –≤–∞—à —á–∞—Ç!"
        )
    }
}

# --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

def get_current_rank_name(xp: int) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–Ω–≥–∞ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É XP"""
    if xp < 40:
        return "–ü–û–†–û–•–û–ë–û–¢–ò üç´"
    elif 40 <= xp < 80:
        return "–ü–û–¢–£–ñ–ù–Ü –ì–†–û–ú–ê–î–Ø–ù–ò üí™"
    elif 80 <= xp < 120:
        return "–°–•–Ü–î–ù–Ø–ö–ò üåÖ"
    elif 120 <= xp < 200:
        return "–•–ê–†–ê–ö–¢–ï–†–ù–ò–ö–ò ‚öîÔ∏è"
    else:
        return "–ó–ï–õ–ï–ë–û–ë–ò üü¢"

# --- –•–ï–ù–î–õ–ï–†–´ (–û–ë–†–ê–ë–û–¢–ß–ò–ö–ò) ---

@dp.message(Command("start"))
async def cmd_start(message: Message):
    await message.answer("–ë–æ—Ç –ü–û–¢–£–ñ–ù–ò–ô –Ω–∞ –∑–≤'—è–∑–∫—É. –ü—Ä–∞—Ü—é—î–º–æ.")

# –ö–æ–º–∞–Ω–¥–∞ /status - —É–∑–Ω–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å —á–∞—Ç–∞
@dp.message(Command("status"))
async def cmd_status(message: Message):
    chat_id = message.chat.id
    # –ü–æ–ª—É—á–∞–µ–º XP –∏–∑ –±–∞–∑—ã (–µ—Å–ª–∏ –Ω–µ—Ç, –±—É–¥–µ—Ç 0)
    xp_raw = redis.get(f"chat:{chat_id}:xp")
    xp = int(xp_raw) if xp_raw else 0
    
    rank_name = get_current_rank_name(xp)
    
    await message.answer(
        f"üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–ø—ñ–ª—å–Ω–æ—Ç–∏**\n\n"
        f"üí¨ –†–∞—Ö—É–Ω–æ–∫: **{xp}**\n"
        f"üèÜ –†–∞–Ω–≥: **{rank_name}**",
        parse_mode="Markdown"
    )

# –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é —Å ID –≥–∏—Ñ–æ–∫ (–æ –∫–æ—Ç–æ—Ä–æ–π —Ç—ã –ø—Ä–æ—Å–∏–ª —Ä–∞–Ω–µ–µ)
@dp.message(F.animation)
async def get_gif_id(message: Message):
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ID –≥–∏—Ñ–∫–∏ (–¥–ª—è —Ç–≤–æ–∏—Ö –Ω—É–∂–¥)
    await message.reply(f"ID —Ü—ñ—î—ó –≥—ñ—Ñ–∫–∏: `{message.animation.file_id}`", parse_mode="Markdown")
    # –ì–∏—Ñ–∫–∏ —Ç–æ–∂–µ —Å—á–∏—Ç–∞–µ–º –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é XP
    await process_xp(message)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –í–°–ï–• –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ –∏ —Ç.–¥.)
@dp.message()
async def handle_all_messages(message: Message):
    await process_xp(message)

# --- –õ–û–ì–ò–ö–ê –ù–ê–ß–ò–°–õ–ï–ù–ò–Ø –û–ü–´–¢–ê ---
async def process_xp(message: Message):
    # –†–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö (–Ω–µ –≤ –ª–∏—á–∫–µ)
    if message.chat.type not in ["group", "supergroup"]:
        return

    chat_id = message.chat.id
    
    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ –±–∞–∑–µ Upstash –Ω–∞ +1
    # redis.incr –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É–≤–µ–ª–∏—á–µ–Ω–∏—è
    new_xp = redis.incr(f"chat:{chat_id}:xp")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º
